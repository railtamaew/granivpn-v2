# üí≥ –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º GraniVPN

## üìã –û–±–∑–æ—Ä –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º

GraniVPN –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ –ø–ª–∞—Ç–µ–∂–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã:

### üåê **–í–µ–±-–ø–ª–∞—Ç–µ–∂–∏**
- **–ÆKassa** - –û—Å–Ω–æ–≤–Ω–∞—è –ø–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è –†–æ—Å—Å–∏–∏
- **CloudPayments** - –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è –ø–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞

### üì± **–ú–æ–±–∏–ª—å–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏**
- **Google Play Billing** - –î–ª—è Android –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
- **App Store In-App Purchases** - –î–ª—è iOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ÆKassa (–Ø–Ω–¥–µ–∫—Å.–ö–∞—Å—Å–∞)

### 1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –ÆKassa

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ [–ÆKassa](https://yookassa.ru/)
2. –ù–∞–∂–º–∏—Ç–µ "–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è"
3. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:
   - –ò–ù–ù –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
   - –û–ì–†–ù/–û–ì–†–ù–ò–ü
   - –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã
   - –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

### 2. –ü–æ–ª—É—á–µ–Ω–∏–µ API –∫–ª—é—á–µ–π

–ü–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è –∑–∞—è–≤–∫–∏:

1. –í–æ–π–¥–∏—Ç–µ –≤ [–ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –ÆKassa](https://yookassa.ru/integration)
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª "–ù–∞—Å—Ç—Ä–æ–π–∫–∏" ‚Üí "API"
3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ:
   - **Shop ID** (–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –º–∞–≥–∞–∑–∏–Ω–∞)
   - **Secret Key** (—Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á)

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ webhook'–æ–≤

1. –í –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏" ‚Üí "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"
2. –î–æ–±–∞–≤—å—Ç–µ URL –¥–ª—è webhook'–æ–≤:
   ```
   https://api.granivpn.com/api/v1/payments/webhook/yandex
   ```
3. –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±—ã—Ç–∏—è –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:
   - `payment.succeeded` - –£—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç–µ–∂
   - `payment.canceled` - –û—Ç–º–µ–Ω–µ–Ω–Ω—ã–π –ø–ª–∞—Ç–µ–∂
   - `refund.succeeded` - –£—Å–ø–µ—à–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç

### 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

–û–±–Ω–æ–≤–∏—Ç–µ —Ñ–∞–π–ª `/opt/granivpn/.env`:

```env
# –ÆKassa
YANDEX_SHOP_ID=your_shop_id_here
YANDEX_SECRET_KEY=your_secret_key_here
```

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CloudPayments

### 1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ CloudPayments

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ [CloudPayments](https://cloudpayments.ru/)
2. –ù–∞–∂–º–∏—Ç–µ "–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è"
3. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∑–∞—è–≤–∫—É:
   - –î–∞–Ω–Ω—ã–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
   - –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã
   - –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

### 2. –ü–æ–ª—É—á–µ–Ω–∏–µ API –∫–ª—é—á–µ–π

–ü–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è:

1. –í–æ–π–¥–∏—Ç–µ –≤ [–ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç CloudPayments](https://merchant.cloudpayments.ru/)
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏" ‚Üí "API"
3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ:
   - **Public ID** (–ø—É–±–ª–∏—á–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä)
   - **API Secret** (—Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á API)

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ webhook'–æ–≤

1. –í –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏" ‚Üí "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"
2. –î–æ–±–∞–≤—å—Ç–µ URL:
   ```
   https://api.granivpn.com/api/v1/payments/webhook/cloudpayments
   ```
3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Å–æ–±—ã—Ç–∏—è:
   - `PaymentSucceeded` - –£—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç–µ–∂
   - `PaymentFailed` - –ù–µ—É–¥–∞—á–Ω—ã–π –ø–ª–∞—Ç–µ–∂
   - `RefundSucceeded` - –£—Å–ø–µ—à–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç

### 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

```env
# CloudPayments
CLOUDPAYMENTS_PUBLIC_ID=your_public_id_here
CLOUDPAYMENTS_API_SECRET=your_api_secret_here
```

## üì± –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Google Play Billing

### 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ –≤ Google Play Store
2. –í Google Play Console –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "–ú–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—è" ‚Üí "–ü–æ–¥–ø–∏—Å–∫–∏"
3. –°–æ–∑–¥–∞–π—Ç–µ –ø–æ–¥–ø–∏—Å–∫–∏:
   - `granivpn_basic` - –ë–∞–∑–æ–≤—ã–π –ø–ª–∞–Ω
   - `granivpn_premium` - –ü—Ä–µ–º–∏—É–º –ø–ª–∞–Ω
   - `granivpn_enterprise` - –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π –ø–ª–∞–Ω

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ü–µ–Ω

–î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–ª–∞–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ü–µ–Ω—ã:
- **Basic**: 299 ‚ÇΩ/–º–µ—Å—è—Ü
- **Premium**: 599 ‚ÇΩ/–º–µ—Å—è—Ü
- **Enterprise**: 999 ‚ÇΩ/–º–µ—Å—è—Ü

### 3. –ü–æ–ª—É—á–µ–Ω–∏–µ Service Account

1. –í Google Play Console –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏" ‚Üí "API –¥–æ—Å—Ç—É–ø"
2. –°–æ–∑–¥–∞–π—Ç–µ Service Account
3. –°–∫–∞—á–∞–π—Ç–µ JSON —Ñ–∞–π–ª —Å –∫–ª—é—á–∞–º–∏
4. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä –≤ `/opt/granivpn/keys/google-play-service-account.json`

### 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

```env
# Google Play Billing
GOOGLE_PLAY_SERVICE_ACCOUNT_PATH=/opt/granivpn/keys/google-play-service-account.json
GOOGLE_PLAY_PACKAGE_NAME=com.granivpn.mobile
```

## üì± –ù–∞—Å—Ç—Ä–æ–π–∫–∞ App Store In-App Purchases

### 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ –≤ App Store
2. –í App Store Connect –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "–ú–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—è" ‚Üí "In-App Purchases"
3. –°–æ–∑–¥–∞–π—Ç–µ –ø–æ–¥–ø–∏—Å–∫–∏:
   - `granivpn_basic` - –ë–∞–∑–æ–≤—ã–π –ø–ª–∞–Ω
   - `granivpn_premium` - –ü—Ä–µ–º–∏—É–º –ø–ª–∞–Ω
   - `granivpn_enterprise` - –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π –ø–ª–∞–Ω

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ü–µ–Ω

–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ü–µ–Ω—ã –≤ App Store Connect:
- **Basic**: 299 ‚ÇΩ/–º–µ—Å—è—Ü
- **Premium**: 599 ‚ÇΩ/–º–µ—Å—è—Ü
- **Enterprise**: 999 ‚ÇΩ/–º–µ—Å—è—Ü

### 3. –ü–æ–ª—É—á–µ–Ω–∏–µ Shared Secret

1. –í App Store Connect –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏ –¥–æ—Å—Ç—É–ø"
2. –°–æ–∑–¥–∞–π—Ç–µ API –∫–ª—é—á —Å –ø—Ä–∞–≤–∞–º–∏ –Ω–∞ In-App Purchases
3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ Shared Secret

### 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

```env
# App Store
APP_STORE_SHARED_SECRET=your_shared_secret_here
APP_STORE_BUNDLE_ID=com.granivpn.mobile
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–µ–π webhook'–æ–≤

#### –ÆKassa
```python
import hmac
import hashlib

def verify_yandex_signature(data, signature, secret_key):
    expected_signature = hmac.new(
        secret_key.encode('utf-8'),
        data.encode('utf-8'),
        hashlib.sha256
    ).hexdigest()
    return hmac.compare_digest(signature, expected_signature)
```

#### CloudPayments
```python
def verify_cloudpayments_signature(data, signature, secret_key):
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ CloudPayments
    expected_signature = hmac.new(
        secret_key.encode('utf-8'),
        data.encode('utf-8'),
        hashlib.sha256
    ).hexdigest()
    return hmac.compare_digest(signature, expected_signature)
```

### 2. –ó–∞—â–∏—Ç–∞ API –∫–ª—é—á–µ–π

- ‚úÖ –•—Ä–∞–Ω–∏—Ç–µ –∫–ª—é—á–∏ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
- ‚úÖ –ù–µ –∫–æ–º–º–∏—Ç—å—Ç–µ –∫–ª—é—á–∏ –≤ Git
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–∞–∑–Ω—ã–µ –∫–ª—é—á–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
- ‚úÖ –†–µ–≥—É–ª—è—Ä–Ω–æ —Ä–æ—Ç–∏—Ä—É–π—Ç–µ –∫–ª—é—á–∏

### 3. SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã

- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTTPS –¥–ª—è –≤—Å–µ—Ö webhook'–æ–≤
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —à–∏—Ñ—Ä—ã

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –¢–µ—Å—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã

#### –ÆKassa
- **–£—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç–µ–∂**: `1111 1111 1111 1026`
- **–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤**: `1111 1111 1111 1047`
- **–ö–∞—Ä—Ç–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞**: `1111 1111 1111 1101`

#### CloudPayments
- **–£—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç–µ–∂**: `4111 1111 1111 1111`
- **–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤**: `4000 0000 0000 0002`
- **–ö–∞—Ä—Ç–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞**: `4000 0000 0000 0001`

### 2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ webhook'–æ–≤

```bash
# –¢–µ—Å—Ç webhook'–∞ –ÆKassa
curl -X POST https://api.granivpn.com/api/v1/payments/webhook/yandex \
  -H "Content-Type: application/json" \
  -d '{
    "type": "notification",
    "event": "payment.succeeded",
    "object": {
      "id": "test_payment_id",
      "status": "succeeded",
      "amount": {
        "value": "299.00",
        "currency": "RUB"
      },
      "metadata": {
        "user_id": 1,
        "subscription_plan": "basic"
      }
    }
  }'
```

### 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–±–∏–ª—å–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π

#### Google Play
```bash
# –¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–∫—É–ø–∫–∏
curl -X POST https://api.granivpn.com/api/v1/payments/verify/google-play \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "purchaseToken": "test_token",
    "productId": "granivpn_basic"
  }'
```

#### App Store
```bash
# –¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–∫—É–ø–∫–∏
curl -X POST https://api.granivpn.com/api/v1/payments/verify/app-store \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "receiptData": "test_receipt_data",
    "productId": "granivpn_basic"
  }'
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–ª–∞—Ç–µ–∂–µ–π

### 1. –õ–æ–≥–∏ –ø–ª–∞—Ç–µ–∂–µ–π

```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –ø–ª–∞—Ç–µ–∂–µ–π
docker logs granivpn-backend | grep -i payment

# –õ–æ–≥–∏ webhook'–æ–≤
docker logs granivpn-backend | grep -i webhook
```

### 2. –ú–µ—Ç—Ä–∏–∫–∏ –≤ Grafana

- üìà –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ –≤—Ä–µ–º–µ–Ω–∏
- üí∞ –û–±—â–∞—è —Å—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–µ–π
- üìä –ö–æ–Ω–≤–µ—Ä—Å–∏—è –ø–ª–∞—Ç–µ–∂–µ–π
- üîç –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º–µ—Ç–æ–¥–∞–º –æ–ø–ª–∞—Ç—ã

### 3. –ê–ª–µ—Ä—Ç—ã

–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–ª–µ—Ä—Ç—ã –¥–ª—è:
- ‚ö†Ô∏è –í—ã—Å–æ–∫–æ–≥–æ –ø—Ä–æ—Ü–µ–Ω—Ç–∞ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
- üö® –û—Ç—Å—É—Ç—Å—Ç–≤–∏—è webhook'–æ–≤ –æ—Ç –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º
- üí∏ –ê–Ω–æ–º–∞–ª—å–Ω—ã—Ö —Å—É–º–º –ø–ª–∞—Ç–µ–∂–µ–π

## üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è

### 1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–æ–∫

```bash
# Cron –∑–∞–¥–∞—á–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å—Ç–µ–∫—à–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫
0 2 * * * /opt/granivpn/scripts/check_expired_subscriptions.sh
```

### 2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –≤–æ–∑–≤—Ä–∞—Ç—ã

```bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–æ–∑–≤—Ä–∞—Ç–æ–≤
0 3 * * * /opt/granivpn/scripts/process_refunds.sh
```

### 3. –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

```bash
# –ë—ç–∫–∞–ø –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
0 4 * * * /opt/granivpn/scripts/backup_payment_data.sh
```

## üÜò –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

#### 1. Webhook'–∏ –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ webhook URL
curl -I https://api.granivpn.com/api/v1/payments/webhook/yandex

# –ü—Ä–æ–≤–µ—Ä–∫–∞ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
openssl s_client -connect api.granivpn.com:443 -servername api.granivpn.com
```

#### 2. –û—à–∏–±–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ API –∫–ª—é—á–µ–π
curl -u "shop_id:secret_key" https://api.yookassa.ru/v3/payments
```

#### 3. –ü–ª–∞—Ç–µ–∂–∏ –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
docker logs granivpn-backend | grep -i "payment.*error"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
docker exec granivpn-backend env | grep -i payment
```

#### 4. –ú–æ–±–∏–ª—å–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ Google Play API
curl -H "Authorization: Bearer $(gcloud auth print-access-token)" \
  https://androidpublisher.googleapis.com/androidpublisher/v3/applications/com.granivpn.mobile/purchases/subscriptions/granivpn_basic/tokens/test_token
```

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

### –ö–æ–Ω—Ç–∞–∫—Ç—ã –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º:

- **–ÆKassa**: support@yookassa.ru
- **CloudPayments**: support@cloudpayments.ru
- **Google Play**: developer-support@google.com
- **App Store**: developer-support@apple.com

### –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏:

- [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ÆKassa](https://yookassa.ru/developers/api)
- [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è CloudPayments](https://developers.cloudpayments.ru/)
- [Google Play Billing](https://developer.android.com/google/play/billing)
- [App Store Connect API](https://developer.apple.com/documentation/appstoreconnectapi)

---

## üéØ –ß–µ–∫-–ª–∏—Å—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### ‚úÖ –ÆKassa
- [ ] –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –ÆKassa
- [ ] –ü–æ–ª—É—á–µ–Ω–∏–µ Shop ID –∏ Secret Key
- [ ] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ webhook'–æ–≤
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π

### ‚úÖ CloudPayments
- [ ] –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ CloudPayments
- [ ] –ü–æ–ª—É—á–µ–Ω–∏–µ Public ID –∏ API Secret
- [ ] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ webhook'–æ–≤
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π

### ‚úÖ Google Play Billing
- [ ] –ü—É–±–ª–∏–∫–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- [ ] –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–æ–∫
- [ ] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ü–µ–Ω
- [ ] –ü–æ–ª—É—á–µ–Ω–∏–µ Service Account
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∫—É–ø–æ–∫

### ‚úÖ App Store In-App Purchases
- [ ] –ü—É–±–ª–∏–∫–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- [ ] –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–æ–∫
- [ ] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ü–µ–Ω
- [ ] –ü–æ–ª—É—á–µ–Ω–∏–µ Shared Secret
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∫—É–ø–æ–∫

### ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–µ–π webhook'–æ–≤
- [ ] –ó–∞—â–∏—Ç–∞ API –∫–ª—é—á–µ–π
- [ ] SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–ª–∞—Ç–µ–∂–µ–π
- [ ] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–ª–µ—Ä—Ç–æ–≤

---

**üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –ü–ª–∞—Ç–µ–∂–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã!**
