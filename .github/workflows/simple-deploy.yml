name: üöÄ Simple Deploy to DigitalOcean

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: üîê Deploy to DigitalOcean Droplet
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.DROPLET_HOST }}
        username: ${{ secrets.DROPLET_USER }}
        key: ${{ secrets.DROPLET_SSH_KEY }}
        port: ${{ secrets.DROPLET_PORT }}
        script: |
          echo "üöÄ –ù–∞—á–∏–Ω–∞—é —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ GraniVPN..."
          
          # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
          cd ~/granivpn-v2 || cd /opt/granivpn || mkdir -p ~/granivpn-v2 && cd ~/granivpn-v2
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
          echo "ÔøΩÔøΩ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
          docker compose -f docker-compose.production.yml down 2>/dev/null || echo "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –Ω–µ –∑–∞–ø—É—â–µ–Ω—ã"
          
          # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã
          echo "üßπ –û—á–∏—â–∞—é —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã..."
          docker system prune -f
          
          # –ö–ª–æ–Ω–∏—Ä—É–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
          if [ -d ".git" ]; then
            echo "üì• –û–±–Ω–æ–≤–ª—è—é –∫–æ–¥..."
            git fetch origin
            git reset --hard origin/main
          else
            echo "üì• –ö–ª–æ–Ω–∏—Ä—É—é –∫–æ–¥..."
            git clone https://github.com/railtamaew/granivpn-v2.git .
          fi
          
          # –°–æ–∑–¥–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
          echo "üìÅ –°–æ–∑–¥–∞—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏..."
          mkdir -p backend/logs wireguard-configs nginx/ssl nginx/sites-enabled
          
          # –ö–æ–ø–∏—Ä—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
          if [ -f "env.production" ]; then
            echo "ÔøΩÔøΩ –ö–æ–ø–∏—Ä—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
            cp env.production .env
          else
            echo "‚ö†Ô∏è  –°–æ–∑–¥–∞—é –±–∞–∑–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
            cat > .env << EOF
          DB_PASSWORD=granivpn_secure_password_2024
          SECRET_KEY=granivpn_super_secret_key_change_this_in_production_2024
          ENVIRONMENT=production
          EOF
          fi
          
          # –°–æ–±–∏—Ä–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
          echo "ÔøΩÔøΩ –°–æ–±–∏—Ä–∞—é –∏ –∑–∞–ø—É—Å–∫–∞—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
          docker compose -f docker-compose.production.yml up --build -d
          
          # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
          echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
          sleep 30
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
          echo "üìä –ü—Ä–æ–≤–µ—Ä—è—é —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤..."
          docker compose -f docker-compose.production.yml ps
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å..."
          if curl -s http://localhost:8000/health > /dev/null; then
            echo "‚úÖ Backend API —Ä–∞–±–æ—Ç–∞–µ—Ç"
          else
            echo "‚ùå Backend API –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
          fi
          
          if curl -s http://localhost:3000 > /dev/null; then
            echo "‚úÖ Admin Panel —Ä–∞–±–æ—Ç–∞–µ—Ç"
          else
            echo "‚ùå Admin Panel –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
          fi
          
          if curl -s http://localhost:8080 > /dev/null; then
            echo "‚úÖ Mobile App —Ä–∞–±–æ—Ç–∞–µ—Ç"
          else
            echo "‚ùå Mobile App –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
          fi
          
          echo ""
          echo "=== üéâ –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û ==="
          echo "üîß Backend API: http://${{ secrets.DROPLET_HOST }}:8000"
          echo "ÔøΩÔøΩÔ∏è Admin Panel: http://${{ secrets.DROPLET_HOST }}:3000"
          echo "üì± Mobile App: http://${{ secrets.DROPLET_HOST }}:8080"
          echo "ÔøΩÔøΩ API Docs: http://${{ secrets.DROPLET_HOST }}:8000/docs"
          echo ""
          echo "–î–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ–º–µ–Ω–∞ –∏ SSL —Å–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤ DIGITALOCEAN_DEPLOYMENT.md"
          
    - name: ‚úÖ Deploy Success
      if: success()
      run: |
        echo "üöÄ GraniVPN —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç –≤ DigitalOcean!"
        echo "–í—Ä–µ–º—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è: $(date)"
        
    - name: ‚ùå Deploy Failed
      if: failure()
      run: |
        echo "‚ùå –û—à–∏–±–∫–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è GraniVPN"
        echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏"
        echo "–í—Ä–µ–º—è –æ—à–∏–±–∫–∏: $(date)"
